---
title: "Coca_analyse"
author: "Arthur Lamblet Vaz"
date: "9/7/2018"
output: html_document
---

```{r setup, include=FALSE}
  #install.packages("rmarkdown")
  library(rmarkdown)
  library(readr)
  library(tidyverse)  
  library(lubridate)
  library(plotly)
  library(readxl)
  #install.packages("prophet")
  library(prophet)
  #install.packages('Metrics')
  library('Metrics')
  require(gridExtra)
```

<center>
![](https://upload.wikimedia.org/wikipedia/commons/d/d4/Coca-Cola_Brasil_logo.png)
</center>

##The Situation:
- You work for a consultant company on the date of December 2017 and a beverages company hired your Analytical service.

##They wanted you to provide:
- A descriptive diagnosis of how this industry is performing through different lenses (**Producers**, **Brands**, **Packages**, **Pricing**)
- A 6-month forecast of volume sales for Brazil to both industry and Producers (From Jan/18 to Jun/18).

```{r , echo=FALSE}
MBI <- read_excel("~/Desktop/Mix_Bev_Industry.xlsx", 
                  col_types = c("date", "text", "text", 
                                "text", "text", "numeric", "text", 
                                "numeric", "numeric", "numeric", 
                                "numeric"))
```

## Market analyse

First and foremost, I will make a quickly analyse of brazilian market. This analyse will help me to choose which direction will be better to follow, as I have a short time to try as many way possible. 
In the firs moment we just have done a data mining to preprer the data for forecast analyse.   
Remark about how I create group of Avarage Pack Size, I used a boxplot to set the size of each group.

- Less than First Quartil and greater than minimum Avarage Pack Size  = Muito pequeno
- Greater than First Quartil and less than Median = Pequeno
- Greater than Median and less than Second Quartil = Grande
- Greater than Second Quartil and less than maximium Avarage Pack Size = Muito Grande

```{r pressure, echo=FALSE}
#CRIACAO DE VALORES, MUDANCA DE CLASSES SERAM FEITAS DENTRO DESSA FUNCAO
manipulacao <- function(){
  #ADICIONAR A VARIAVEL MES
  MBI$Month <- month(MBI$Date)
  #ADICIONAR A VARIAVEL ANO
  MBI$Year <- year(MBI$Date)
  #VERIFICAR A CLASSE DAS VARIAVEIS
  lapply(MBI[,c("Date","Volume","Value")],class)
  #ADICIONAR A VARIAVEL PRECO
  MBI$Volume <- round(as.numeric(gsub(",", ".", gsub("\\.", "", MBI$Volume))),2)
  MBI$Value <- round(as.numeric(gsub(",", ".", gsub("\\.", "", MBI$Value))),2)
  MBI$Price <- round(with(MBI, Value/Volume),2)
  #CATEGORIZAR AVG PACK SIZE POR 1Q/MEDIANA/3Q
  summary(MBI$`Avg. Pack.Size`)
  boxplot(MBI$`Avg. Pack.Size`)
  text(y = boxplot.stats(MBI$`Avg. Pack.Size`)$stats, labels = boxplot.stats(MBI$`Avg. Pack.Size`)$stats, x = 1.25)
  MBI$AVG_PS <- with(MBI, ifelse(`Avg. Pack.Size` <= 61 & `Avg. Pack.Size` >=48, "MUITO PEQUENO",
                                 ifelse(`Avg. Pack.Size`>61 & `Avg. Pack.Size`<=67,"PEQUENO",
                                        ifelse(`Avg. Pack.Size`>67 & `Avg. Pack.Size`<=80,"GRANDE",
                                               ifelse(`Avg. Pack.Size`> 80 & `Avg. Pack.Size`<=84,"MUITO GRANDE","OUTLIER")))))  
  return(MBI)
}
MBI <- manipulacao()
```

The first graphic bellow ,volume and value normalized, helps us to undestand the moviment of market. In 2016, the volume market sharply drecrease more than the value market, even drecrease less than before as you can note the blue line slope. 
One of my issue after June 2016 is the price may impact the volume, the red line is almost flat.

```{r , echo=FALSE, message=FALSE}
mercado_grafico1 <- function(){
      MBI_mercado <- MBI[,c("Value","Volume","Date")]
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado <- as.data.frame(MBI_mercado)
      aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date), FUN = sum)  %>%
        ggplot() +
        geom_smooth(aes(x=Group.1, y = Value, colour = "blue")) +
        geom_smooth(aes(x=Group.1, y = Volume, colour = "green")) + 
        scale_color_discrete(name = "Valores no tempo", labels = c("Valor", "Volume"))
}
mercado_grafico1()
```

For a confirm conclusion about the price, we can note in the 2 chart beloow the size of point which mean the price, did not change pasting time.

```{r, echo=FALSE, message=FALSE}
    mercado_grafico2 <- function(){
      MBI_mercado <- MBI[,c("Value","Volume","Date")]
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado <- as.data.frame(MBI_mercado)
      MBI_mercado <- aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date), FUN = sum)
      MBI_mercado$Price <- MBI_mercado$Value/MBI_mercado$Volume
      MBI_mercado %>%
        ggplot() +
        geom_point(aes(x=Group.1, y = Volume, size = Price)) + ylim(min(MBI_mercado$Volume),max(MBI_mercado$Volume))
    }
    mercado_grafico3 <- function(){
      MBI_mercado <- MBI[,c("Value","Volume","Date")]
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado <- as.data.frame(MBI_mercado)
      MBI_mercado <- aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date), FUN = sum)
      MBI_mercado$Price <- MBI_mercado$Value/MBI_mercado$Volume
      MBI_mercado %>%
        ggplot() +
        geom_point(aes(x=Group.1, y = Value, size = Price)) + ylim(min(MBI_mercado$Volume),max(MBI_mercado$Volume))
    }
    grid.arrange(mercado_grafico2(), mercado_grafico3(), ncol=2)
```

A quick undestand which Flavor has more impact in the market, easly notice in the graphic bellow the Flavor Milk Chocolate has a huge impact in the market result. So could be interst do different analyses, a cluster of Milk Chocolate and a cluster of another Flavors. Spliting in two cluster and zoom the second one, we can see cherry flavor follow by coffe flavor are most predominant. 

```{r, echo=FALSE, message=FALSE}
mercado_grafico4 <- function(){
      MBI_mercado <- MBI[,c("Value","Volume","Date","Flavor")]
      MBI_mercado <- aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date,MBI_mercado$Flavor), FUN = sum)
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado$Price <- MBI_mercado$Value/MBI_mercado$Volume
      MBI_mercado <- as.data.frame(MBI_mercado)
      MBI_mercado$Cluster <- ifelse(MBI_mercado$Group.2=="Milk Chocolate",1,2)
      
      t <- MBI_mercado %>%
        ggplot() +
        geom_point(aes(x=Volume, y = Value, size = Price, fill = Group.2), shape = 21) + 
        ylim(min(MBI_mercado$Volume),max(MBI_mercado$Volume))
      ggplotly(t)
    }
mercado_grafico5 <- function(){
      MBI_mercado <- MBI[MBI$Flavor!="Milk Chocolate",c("Value","Volume","Date","Flavor")]
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado <- as.data.frame(MBI_mercado)
      MBI_mercado <- aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date,MBI_mercado$Flavor), FUN = sum)
      MBI_mercado$Price <- MBI_mercado$Value/MBI_mercado$Volume
      t <- MBI_mercado %>%
        ggplot() +
        geom_point(aes(x=Volume, y = Value, size = Price, fill = Group.2), shape = 21) + 
        ylim(min(MBI_mercado$Volume),max(MBI_mercado$Volume)) +
        scale_size(range = c(1, 10))
      ggplotly(t)
    }
mercado_grafico4()
mercado_grafico5()
```

Now, you can check witouth be normalized. I had to use 3 different graph because the range of values is large, so if try to plot in a single chart, woulb clear the information.

```{r , echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico6 <- function(){
      MBI_tb <- MBI[,c("Value","Volume","Date","Flavor")]
      MBI_tb$Month <- month(MBI_tb$Date)
      MBI_tb <- aggregate(MBI_tb[,c("Value","Volume")], by = list(MBI_tb$Month, MBI_tb$Flavor), FUN = sum)
      MBI_tb$Price <- MBI_tb$Value/MBI_tb$Volume
      colnames(MBI_tb) <- c("Month","Flavor","Value","Volume","Price")
      MBI_tb <- MBI_tb%>%gather(Atributos, Valores, Value:Price)
      t <- MBI_tb%>%
        ggplot(aes(y= Valores, x =Flavor, fill = Flavor)) + 
        geom_bar(stat = "identity") + 
        facet_wrap(Atributos ~ ., scales = "free") +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_text(size=15))
      ggplotly(t)
}
mercado_grafico6()
```

Analysing the material market, as easy to realise the plastic predominant, the clomun chart on the left is the value market and on the right volume market by material package. In the end of 2017 seems exist a inverse correlation or just a casuality because the campaing agains plastics are inrease nowadays.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico7 <- function(){
      MBI_grafico <- aggregate(MBI[,c("Value","Volume")], by = list(Material = MBI$`Pack Material`,  Year = MBI$Year, Month = MBI$Month), FUN = sum)
      MBI_grafico$Price <- MBI_grafico$Value/MBI_grafico$Volume  
      
      g <- ggplot(MBI_grafico, aes(x=Month, y=Value,colour=Material)) + 
        geom_line(stat='identity') + 
        facet_grid(Year ~ .)  +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_blank(),
              legend.position="none")
      ggplotly(g)
    }
mercado_grafico8 <- function(){
      MBI_grafico <- aggregate(MBI[,c("Value","Volume")], by = list(Material = MBI$`Pack Material`,  Year = MBI$Year, Month = MBI$Month), FUN = sum)
      MBI_grafico$Price <- MBI_grafico$Value/MBI_grafico$Volume  
      
      g <- ggplot(MBI_grafico, aes(x=Month, y=Volume,colour=Material)) + 
        geom_line(stat='identity') + 
        facet_grid(Year ~ .) +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_text(size=10),
              legend.title = element_blank()) +
              guides(fill=FALSE)
      ggplotly(g)  %>%
        layout(legend = list(
          orientation = "v", x = 1.1, y =0.5
        )
        )
}
subplot(mercado_grafico7(),mercado_grafico8())
```

The caloric content always have been dominated by sugar, the graphic bellow can prove this sentence.

```{r,echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico9 <- function(){
      MBI_grafico <- aggregate(MBI[,c("Value","Volume")], by = list('Caloric Content' = MBI$`Caloric Content`, Year = MBI$Year, Month = MBI$Month), FUN = sum)
      MBI_grafico$Price <- MBI_grafico$Value/MBI_grafico$Volume  
      
      g <- ggplot(MBI_grafico, aes(x=Month, y=Value,colour=`Caloric Content`)) + 
        geom_line(stat='identity') + 
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_text(size=10),
              legend.title = element_blank()) +
        facet_grid(Year ~ .) 
      ggplotly(g)%>%
        layout(legend = list(
          orientation = "v", x = 1.1, y =0.5
        )
        )
    }
mercado_grafico9()
```

The market has two type of size package that lead the other.

```{r,echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico10 <- function(){
      MBI_grafico <- aggregate(MBI[,c("Value","Volume")], by = list(MBI$AVG_PS, MBI$Year, MBI$Month), FUN = sum)
      MBI_grafico$Price <- MBI_grafico$Value/MBI_grafico$Volume  
      
      g <- ggplot(MBI_grafico, aes(x=Group.3, y=Value,colour=Group.1)) + 
        geom_line(stat='identity') + 
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_text(size=10),
              legend.title = element_blank()) +
        facet_grid(Group.2 ~ .)
      ggplotly(g)%>%
        layout(legend = list(
          orientation = "v", x = 1.1, y =0.5
        )
        )
}
mercado_grafico10()
```



After understand the market, we can set the categories more influencer for run the forecast model, is usual help in the computer performance because will work with less data.

```{r,echo=FALSE, message=FALSE, warning=FALSE}
mercado_month <- function(){
      MBI$Month <- month(MBI$Date)
      aggregate(MBI[,c("Value","Volume")], by = list(Month = MBI$Month), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
    }
    mercado_year <- function(){
      MBI$Year <- year(MBI$Date)
      aggregate(MBI[,c("Value","Volume")], by = list(Year =MBI$Year), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
    } 
    grid.arrange(tableGrob(mercado_year(), rows = NULL),
               tableGrob(mercado_month(), rows = NULL), nrow = 1)
    mercado_grafico11 <- function(){
      MBI$Month <- month(MBI$Date)
      MBI_tb <- aggregate(MBI[,c("Value","Volume")], by = list(Month = MBI$Year), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
      MBI_tb <- MBI_tb%>%gather(Atributos, Valores, Value:Price)
      t <- MBI_tb%>%
        ggplot(aes(y= Valores, x =Month)) + 
        geom_line(stat = "identity") +
        facet_wrap(Atributos~ ., scales = "free") + 
        theme_bw() +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_text(angle = 90, hjust = 1),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text=element_text(hjust=-100))
      ggplotly(t)
    }
    mercado_grafico11()
```