---
title: "Coca_analyse"
author: "Arthur Lamblet Vaz"
date: "9/7/2018"
output: html_document
---

```{r setup, include=FALSE}
  #install.packages("rmarkdown")
  library(rmarkdown)
  library(readr)
  library(tidyverse)  
  library(lubridate)
  library(plotly)
  library(readxl)
  #install.packages("prophet")
  library(prophet)
  #install.packages('Metrics')
  library('Metrics')
  require(gridExtra)
  #install.packages("devtools")
  library(devtools)
 #devtools::install_github('hadley/ggplot2', force = TRUE)
  #install.packages("corrplot")
  library(corrplot)
  library("Hmisc")
  #install.packages("PerformanceAnalytics")
  library("PerformanceAnalytics")
```

<center>
![](https://upload.wikimedia.org/wikipedia/commons/d/d4/Coca-Cola_Brasil_logo.png)
</center>

##The Situation:
- You work for a consultant company on the date of December 2017 and a beverages company hired your Analytical service.

##They wanted you to provide:
- A descriptive diagnosis of how this industry is performing through different lenses (**Producers**, **Brands**, **Packages**, **Pricing**)
- A 6-month forecast of volume sales for Brazil to both industry and Producers (From Jan/18 to Jun/18).

## Market analyse

First and foremost, I will make a quickly analyse of brazilian market. This analyse will help me to choose which direction will be better to follow, as I have a short time to try as many way possible. 
In the firs moment we just have done a data mining to preprer the data for forecast analyse.   
Remark about how I create group of Avarage Pack Size, I used a boxplot to set the size of each group.

- Less than First Quartil and greater than minimum Avarage Pack Size  = VERY SMALL
- Greater than First Quartil and less than Median = SMALL
- Greater than Median and less than Second Quartil = BIG
- Greater than Second Quartil and less than maximium Avarage Pack Size = VERY BIG

```{r pressure, echo=FALSE}
#CRIACAO DE VALORES, MUDANCA DE CLASSES SERAM FEITAS DENTRO DESSA FUNCAO
manipulacao <- function(){
  #CARREGAR TABELA EXCEL
  MBI <- read_excel("~/Desktop/Mix_Bev_Industry.xlsx", 
                    col_types = c("date", "text", "text", 
                                  "text", "text", "numeric", "text", 
                                  "numeric", "numeric", "numeric", 
                                  "numeric"))
  #ADICIONAR A VARIAVEL MES
  MBI$Month <- month(MBI$Date)
  #ADICIONAR A VARIAVEL ANO
  MBI$Year <- year(MBI$Date)
  #VERIFICAR A CLASSE DAS VARIAVEIS
  lapply(MBI[,c("Date","Volume","Value")],class)
  #ADICIONAR A VARIAVEL PRECO
  MBI$Volume <- round(as.numeric(gsub(",", ".", gsub("\\.", "", MBI$Volume))),2)
  MBI$Value <- round(as.numeric(gsub(",", ".", gsub("\\.", "", MBI$Value))),2)
  MBI$Price <- round(with(MBI, Value/Volume),2)
  MBI$AVG_PS <- with(MBI, ifelse(`Avg. Pack.Size` <= 61 & `Avg. Pack.Size` >=48, "VERY SMALL",
                                 ifelse(`Avg. Pack.Size`>61 & `Avg. Pack.Size`<=67,"SMALL",
                                        ifelse(`Avg. Pack.Size`>67 & `Avg. Pack.Size`<=80,"BIG",
                                               ifelse(`Avg. Pack.Size`> 80 & `Avg. Pack.Size`<=84,"VERY BIG","OUTLIER")))))
  return(MBI)
}
boxplot_grafico <- function(){
  MBI <- manipulacao()
  #CATEGORIZAR AVG PACK SIZE POR 1Q/MEDIANA/3Q
  summary(MBI$`Avg. Pack.Size`)
  boxplot(MBI$`Avg. Pack.Size`)
  text(y = boxplot.stats(MBI$`Avg. Pack.Size`)$stats, labels = boxplot.stats(MBI$`Avg. Pack.Size`)$stats, x = 1.25)
}
#PARETO E PARETO CHART
pareto <- function(x,y){
  #PRIMEIRO ARGUMENTO E O CONJUNTO DE DADOS
  #SEGUNDO A VARIAVEL PARA FAZER O PARETO
  d <- arrange(x, desc(y)) %>%
    mutate(
      cumsum = cumsum(y),
      freq = round(y / sum(y), 3),
      cum_freq = cumsum(freq)
    )
  return(d)
}
pareto_grafico <- function(x,y,z){
  d <- pareto(x,y)
  ## Saving Parameters 
  def_par <- par() 
  
  # New margins
  par(mar=c(5,5,4,5)) 
  
  ## plot bars, pc will hold x values for bars
  pc = barplot(d$y,
               width = 1, space = 0.2, border = NA, axes = F,
               ylim = c(0, 1.05 * max(d$y, na.rm = T)), 
               ylab = "Counts" , cex.names = 0.7, 
               names.arg = d$z,
               main = "Pareto Chart (version 2)")
  
  ## anotate left axis
  axis(side = 2, at = c(0, d$y), las = 1, col.axis = "grey62", col = "grey62", tick = T, cex.axis = 0.8)
  
  ## frame plot
  box( col = "grey62")
  
  ## Cumulative Frequency Lines 
  px <- d$cum_freq * max(d$y, na.rm = T)
  lines(pc, px, type = "b", cex = 0.7, pch = 19, col="cyan4")
  
  ## Annotate Right Axis
  axis(side = 4, at = c(0, px), labels = paste(c(0, round(d$cum_freq * 100)) ,"%",sep=""), 
       las = 1, col.axis = "grey62", col = "cyan4", cex.axis = 0.8, col.axis = "cyan4")
  
  ## restoring default paramenter
  par(def_par) 
  
}
boxplot_grafico()
```

The first graphic bellow ,volume and value normalized, helps us to undestand the moviment of market. In 2016, the volume market sharply drecrease more than the value market, even drecrease less than before as you can note the blue line slope. 
One of my issue after June 2016 is the price may impact the volume, the red line is almost flat.

```{r , echo=FALSE, message=FALSE}
mercado_grafico1 <- function(){
      MBI <- manipulacao()
      MBI_mercado1 <- MBI[,c("Value","Volume","Date")]
      #E PRECISO NORMALIZAR PARA QUE A GRANDEZA FICA NA MESMA ESCALA CASO AO CONTRARIO NAO DA PARA COMPARAR
      MBI_mercado1[,c("Value","Volume")] <- scale(MBI_mercado1[,c("Value","Volume")])
      MBI_mercado1 <- as.data.frame(MBI_mercado1)
      aggregate(MBI_mercado1[,c("Value","Volume")],by = list(MBI_mercado1$Date), FUN = sum)  %>%
        ggplot() +
        geom_smooth(aes(x=Group.1, y = Value, colour = "blue"),show.legend = FALSE) +
        geom_smooth(aes(x=Group.1, y = Volume, colour = "green"),show.legend = FALSE) + 
        scale_color_discrete(name = "Valores no tempo", labels = c("Valor", "Volume"))
    }
mercado_grafico1()
```

For a confirm conclusion about the price, we can note in the 2 chart beloow the size of point which mean the price, did not change pasting time.

```{r, echo=FALSE, message=FALSE}
    mercado_grafico2 <- function(){
      MBI <- manipulacao()
      MBI_mercado <- MBI[,c("Value","Volume","Date")]
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado <- as.data.frame(MBI_mercado)
      MBI_mercado <- aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date), FUN = sum)
      MBI_mercado$Price <- MBI_mercado$Value/MBI_mercado$Volume
      MBI_mercado %>%
        ggplot() +
        geom_point(aes(x=Group.1, y = Volume, size = Price)) + ylim(min(MBI_mercado$Volume),max(MBI_mercado$Volume))
    }
    mercado_grafico3 <- function(){
      MBI <- manipulacao()
      MBI_mercado <- MBI[,c("Value","Volume","Date")]
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado <- as.data.frame(MBI_mercado)
      MBI_mercado <- aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date), FUN = sum)
      MBI_mercado$Price <- MBI_mercado$Value/MBI_mercado$Volume
      MBI_mercado %>%
        ggplot() +
        geom_point(aes(x=Group.1, y = Value, size = Price)) + ylim(min(MBI_mercado$Volume),max(MBI_mercado$Volume))
    }
    grid.arrange(mercado_grafico2(), mercado_grafico3(), ncol=2)
```

A quick undestand which Flavor has more impact in the market, easly notice in the graphic bellow the Flavor Milk Chocolate has a huge impact in the market result. So could be interst do different analyses, a cluster of Milk Chocolate and a cluster of another Flavors. Spliting in two cluster and zoom the second one, we can see cherry flavor follow by coffe flavor are most predominant. 

```{r, echo=FALSE, message=FALSE}
mercado_grafico4 <- function(){
      MBI <- manipulacao()
      MBI_mercado <- MBI[,c("Value","Volume","Date","Flavor")]
      MBI_mercado <- aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date,MBI_mercado$Flavor), FUN = sum)
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado$Price <- MBI_mercado$Value/MBI_mercado$Volume
      MBI_mercado <- as.data.frame(MBI_mercado)
      MBI_mercado$Cluster <- ifelse(MBI_mercado$Group.2=="Milk Chocolate",1,2)
      
      t <- MBI_mercado %>%
        ggplot() +
        geom_point(aes(x=Volume, y = Value, size = Price, fill = Group.2), shape = 21) + 
        ylim(min(MBI_mercado$Volume),max(MBI_mercado$Volume))
      ggplotly(t)
    }
mercado_grafico5 <- function(){
      MBI <- manipulacao()
      MBI_mercado <- MBI[MBI$Flavor!="Milk Chocolate",c("Value","Volume","Date","Flavor")]
      MBI_mercado[,c("Value","Volume")] <- scale(MBI_mercado[,c("Value","Volume")])
      MBI_mercado <- as.data.frame(MBI_mercado)
      MBI_mercado <- aggregate(MBI_mercado[,c("Value","Volume")],by = list(MBI_mercado$Date,MBI_mercado$Flavor), FUN = sum)
      MBI_mercado$Price <- MBI_mercado$Value/MBI_mercado$Volume
      t <- MBI_mercado %>%
        ggplot() +
        geom_point(aes(x=Volume, y = Value, size = Price, fill = Group.2), shape = 21) + 
        ylim(min(MBI_mercado$Volume),max(MBI_mercado$Volume)) +
        scale_size(range = c(1, 10))
      ggplotly(t)
    }
mercado_grafico4()
mercado_grafico5()
```

Now, you can check witouth be normalized. I had to use 3 different graph because the range of values is large, so if try to plot in a single chart, woulb clear the information.

```{r , echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico6 <- function(){
      MBI <- manipulacao()
      MBI_tb <- MBI[,c("Value","Volume","Date","Flavor")]
      MBI_tb$Month <- month(MBI_tb$Date)
      MBI_tb <- aggregate(MBI_tb[,c("Value","Volume")], by = list(MBI_tb$Month, MBI_tb$Flavor), FUN = sum)
      MBI_tb$Price <- MBI_tb$Value/MBI_tb$Volume
      colnames(MBI_tb) <- c("Month","Flavor","Value","Volume","Price")
      MBI_tb <- MBI_tb%>%gather(Atributos, Valores, Value:Price)
      t <- MBI_tb%>%
        ggplot(aes(y= Valores, x =Flavor, fill = Flavor)) + 
        geom_bar(stat = "identity") + 
        facet_wrap(Atributos ~ ., scales = "free") +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_text(size=15))
      ggplotly(t)
    }
mercado_grafico6()
```

Analysing the material market, as easy to realise the plastic predominant, the clomun chart on the left is the value market and on the right volume market by material package. In the end of 2017 seems exist a inverse correlation or just a casuality because the campaing agains plastics are inrease nowadays.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico7 <- function(){
      MBI <- manipulacao()
      MBI_grafico <- aggregate(MBI[,c("Value","Volume")], by = list(Material = MBI$`Pack Material`,  Year = MBI$Year, Month = MBI$Month), FUN = sum)
      MBI_grafico$Price <- MBI_grafico$Value/MBI_grafico$Volume  
      
      g <- ggplot(MBI_grafico, aes(x=Month, y=Value,colour=Material)) + 
        geom_line(stat='identity') + 
        ggtitle("Value") +
        facet_grid(Year ~ .)  +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_blank())+
        guides(fill=FALSE)
      ggplotly(g)%>%
        layout(legend = list(
          orientation = "v", x = 1.1, y =0.5
        )
        )
    }
mercado_grafico8 <- function(){
      MBI <- manipulacao()
      MBI_grafico <- aggregate(MBI[,c("Value","Volume")], by = list(Material = MBI$`Pack Material`,  Year = MBI$Year, Month = MBI$Month), FUN = sum)
      MBI_grafico$Price <- MBI_grafico$Value/MBI_grafico$Volume  
      
      g <- ggplot(MBI_grafico, aes(x=Month, y=Volume,colour=Material)) + 
        geom_line(stat='identity') + 
        ggtitle("Volume") +
        facet_grid(Year ~ .) +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_text(size=10)) +
        guides(fill=FALSE)
      ggplotly(g)  %>%
        layout(legend = list(
          orientation = "v", x = 1.1, y =0.5
        )
        )
    }
mercado_grafico7()
mercado_grafico8()
```

The caloric content always have been dominated by sugar, the graphic bellow can prove this sentence.

```{r,echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico9 <- function(){
      MBI <- manipulacao()
      MBI_grafico <- aggregate(MBI[,c("Value","Volume")], by = list('Caloric Content' = MBI$`Caloric Content`, Year = MBI$Year, Month = MBI$Month), FUN = sum)
      MBI_grafico$Price <- MBI_grafico$Value/MBI_grafico$Volume  
      
      g <- ggplot(MBI_grafico, aes(x=Month, y=Value,colour=`Caloric Content`)) + 
        geom_line(stat='identity') + 
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_text(size=10),
              legend.title = element_blank()) +
        facet_grid(Year ~ .) 
      ggplotly(g)%>%
        layout(legend = list(
          orientation = "v", x = 1.1, y =0.5
        )
        )
    }
mercado_grafico9()
```

The market has two type of size package that lead the other.

```{r,echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico10 <- function(){
      MBI <- manipulacao()
      MBI_grafico <- aggregate(MBI[,c("Value","Volume")], by = list(MBI$AVG_PS, MBI$Year, MBI$Month), FUN = sum)
      MBI_grafico$Price <- MBI_grafico$Value/MBI_grafico$Volume  
      
      g <- ggplot(MBI_grafico, aes(x=Group.3, y=Value,colour=Group.1)) + 
        geom_line(stat='identity') + 
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank(),
              axis.ticks.y=element_blank(),
              strip.text = element_text(size=10),
              legend.title = element_blank()) +
        facet_grid(Group.2 ~ .)
      ggplotly(g)%>%
        layout(legend = list(
          orientation = "v", x = 1.1, y =0.5
        )
        )
    }
mercado_grafico10()
```



After understand the market, we can set the categories more influencer for run the forecast model, is usual help in the computer performance because will work with less data.

```{r,echo=FALSE, message=FALSE, warning=FALSE}
mercado_month <- function(){
      MBI <- manipulacao()
      aggregate(MBI[,c("Value","Volume")], by = list(Month = MBI$Month), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
    }
mercado_year <- function(){
      MBI <- manipulacao()
      aggregate(MBI[,c("Value","Volume")], by = list(Year =MBI$Year), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
    } 
grid.arrange(tableGrob(mercado_year(), rows = NULL),
               tableGrob(mercado_month(), rows = NULL), nrow = 1)

```

Another way to understand the table is plotting in a line chart by year. The drecreasing moviment is not visible just in the chart along months, but is visible if we look at y axis. The same information that is in the table above, is confirm in the charts.

- Volume dramatically dropped
- Value gradually dropped
- Price rose month by month

```{r, echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico11 <- function(){
      MBI <- manipulacao()
      MBI_tb <- aggregate(MBI[,c("Value","Volume")], by = list(Year = MBI$Year,Month = MBI$Month), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
      MBI_tb <- MBI_tb%>%gather(Atributos, Valores, Value:Price)
      t <- MBI_tb[MBI_tb$Atributos=="Volume",]%>%
        ggplot(aes(y= Valores, x =Month)) + 
        geom_line(stat = "identity") +
        ggtitle("Volume") +
        facet_grid(Year ~ ., scales = "free")+ 
        theme_bw() +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_text(angle = 90, hjust = 1),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.ticks.y=element_blank(),
              plot.title = element_text(hjust = 0.5)) + 
        scale_x_continuous(labels = scales::comma,breaks = seq(1, 12, by = 1)) +
        scale_y_continuous(labels = scales::comma)
      t
    }
mercado_grafico12 <- function(){
      MBI <- manipulacao()
      MBI_tb <- aggregate(MBI[,c("Value","Volume")], by = list(Year = MBI$Year,Month = MBI$Month), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
      MBI_tb <- MBI_tb%>%gather(Atributos, Valores, Value:Price)
      t <- MBI_tb[MBI_tb$Atributos=="Value",]%>%
        ggplot(aes(y= Valores, x =Month)) + 
        geom_line(stat = "identity") +
        ggtitle("Value") +
        facet_grid(Year ~ ., scales = "free")+ 
        theme_bw() +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_text(angle = 90, hjust = 1),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.ticks.y=element_blank(),
              plot.title = element_text(hjust = 0.5)) + 
        scale_x_continuous(labels = scales::comma,breaks = seq(1, 12, by = 1)) +
        scale_y_continuous(labels = scales::comma)
      t
    }
mercado_grafico13 <- function(){
      MBI <- manipulacao()
      MBI_tb <- aggregate(MBI[,c("Value","Volume")], by = list(Year = MBI$Year,Month = MBI$Month), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
      MBI_tb <- MBI_tb%>%gather(Atributos, Valores, Value:Price)
      t <- MBI_tb[MBI_tb$Atributos=="Price",]%>%
        ggplot(aes(y= Valores, x =Month)) + 
        geom_line(stat = "identity") +
        ggtitle("Price") +
        facet_grid(Year ~ ., scales = "free")+ 
        theme_bw() +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_text(angle = 90, hjust = 1),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.ticks.y=element_blank(),
              plot.title = element_text(hjust = 0.5))  +
        scale_x_continuous(labels = scales::comma,breaks = seq(1, 12, by = 1)) +
        scale_y_continuous(labels = scales::comma)
      t
    }
mercado_grafico11()
mercado_grafico12()
mercado_grafico13()
```

There are 2 facts more that could have strong influence in the market, Coverage and Shelf Life. Was calculated the mean by Year and Month, as you can see, the charts the coverage is decreasing since January 2015 so may be one of factor which has strong influence in the Market. The shelf life, in overall, keep in the same range and is clear to notice the sazonality in the end of the year. The histogram and density chart help us to detect any outlier which could mess up the mean result.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
mercado_grafico14 <- function(){
      MBI <- manipulacao()
      MBI_tb <- aggregate(MBI[,"Coverage"], by = list(Year = MBI$Year,Month = MBI$Month), FUN = mean, na.rm = TRUE)
      MBI_tb <- MBI_tb%>%gather(Atributos, Valores, Coverage)
      t <- MBI_tb[MBI_tb$Atributos=="Coverage",]%>%
        ggplot(aes(y= Valores, x =Month)) + 
        geom_line(stat = "identity") +
        ggtitle("Coverage") +
        facet_grid(Year ~ ., scales = "free")+ 
        theme_bw() +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_text(angle = 90, hjust = 1),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.ticks.y=element_blank(),
              plot.title = element_text(hjust = 0.5)) + 
        scale_x_continuous(labels = scales::comma,breaks = seq(1, 12, by = 1)) 
      t
    }
mercado_grafico15 <- function(){
      MBI <- manipulacao()
      x <- density(MBI$Coverage, na.rm = TRUE)
      hist(MBI$Coverage, main = "Coverage Histogram")
      plot(x, main = "Coverage Kernel Distribution")
    }
mercado_grafico16 <- function(){
      MBI <- manipulacao()
      MBI_tb <- aggregate(MBI[,"Shelf_Availability"], by = list(Year = MBI$Year,Month = MBI$Month), FUN = mean, na.rm = TRUE)
      MBI_tb <- MBI_tb%>%gather(Atributos, Valores, Shelf_Availability)
      t <- MBI_tb[MBI_tb$Atributos=="Shelf_Availability",]%>%
        ggplot(aes(y= Valores, x =Month)) + 
        geom_line(stat = "identity") +
        ggtitle("Shelf_Availability") +
        facet_grid(Year ~ ., scales = "free")+ 
        theme_bw() +
        theme(axis.title.x=element_blank(),
              axis.text.x=element_text(angle = 90, hjust = 1),
              axis.ticks.x=element_blank(),
              axis.title.y=element_blank(),
              axis.ticks.y=element_blank(),
              plot.title = element_text(hjust = 0.5)) + 
        scale_x_continuous(labels = scales::comma,breaks = seq(1, 12, by = 1)) 
      t
    }
mercado_grafico17 <- function(){
      MBI <- manipulacao()
      x <- density(MBI$Shelf_Availability, na.rm = TRUE)
      par(mfrow=c(2,1))
      y <- hist(MBI$Coverage, main = "Shelf Availability Histogram")
      x1 <- plot(x, main = "Shelf Availability Kernel Distribution")
    }

mercado_grafico14()
mercado_grafico15()
mercado_grafico16()
mercado_grafico17()
```

For help us to identify the strong correlation in the variables, the two chart bellow will clarify all issue which could appear. We can conclued

- The price variable is inverse corroelated to Volume, Coverage and Shelf Availability
- The volume variable is corroelated to Coverage and Shelf Availability

```{r, echo=FALSE, message=FALSE, warning=FALSE}
    mercado_grafico19 <- function(){
      MBI <- manipulacao()
      MBI_tb1 <- aggregate(MBI[,"Coverage"], by = list(Year = MBI$Year,Month = MBI$Month), FUN = mean, na.rm = TRUE)
      MBI_tb2 <- aggregate(MBI[,"Shelf_Availability"], by = list(Year = MBI$Year,Month = MBI$Month), FUN = mean, na.rm = TRUE)
      MBI_tb3 <- aggregate(MBI[,c("Value","Volume")], by = list(Year = MBI$Year,Month = MBI$Month), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
      MBI_tb <- dplyr::left_join(MBI_tb3,MBI_tb2, by = c('Month','Year'))
      MBI_tb <- dplyr::left_join(MBI_tb,MBI_tb1, by = c('Month','Year'))
      res2 <- rcorr(as.matrix(MBI_tb[,c("Coverage","Shelf_Availability","Value","Volume","Price")]))
      par(mfrow=c(1,1))
      corrplot(res2$r, type="upper", order="hclust", 
               p.mat = res2$P, sig.level = 0.05, insig = "blank")  
    }
    mercado_grafico20 <- function(){
      MBI <- manipulacao()
      MBI_tb1 <- aggregate(MBI[,"Coverage"], by = list(Year = MBI$Year,Month = MBI$Month), FUN = mean, na.rm = TRUE)
      MBI_tb2 <- aggregate(MBI[,"Shelf_Availability"], by = list(Year = MBI$Year,Month = MBI$Month), FUN = mean, na.rm = TRUE)
      MBI_tb3 <- aggregate(MBI[,c("Value","Volume")], by = list(Year = MBI$Year,Month = MBI$Month), FUN = sum)%>%
        mutate(Price = round(Value / Volume,2))
      MBI_tb <- dplyr::left_join(MBI_tb3,MBI_tb2, by = c('Month','Year'))
      MBI_tb <- dplyr::left_join(MBI_tb,MBI_tb1, by = c('Month','Year'))
      chart.Correlation(MBI_tb[,c("Coverage","Shelf_Availability","Value","Volume","Price")], histogram=TRUE, pch=19)
    }
    
    mercado_grafico19()
    mercado_grafico20()
```

##Forcast scene 

Now, we are able to choose the best atributes for work with forecast with less data and the result will be able to describe the market as well. Follow the atributes:

- Flavor: Milk Chocolate, Cherry and Coffe
- Caloric Content: Sugar
- Average Package Size: Big and very small

We can not assume a cluster with these atributes together because was made analyse independet. So if the row has one of these tree atributes will be acptable to work. The cluster that has been create represent 97% of the whole volume and 96% of the whole value.

The last month result in 2017, the brand Lili drop by 64,8% share volume and Gen up by 25,4% share volume, if you analyse the Price Index will be possible to realise the price has a strong influence because the brand Lili rose the price by 40% over the market price and the Glen brand dramatically dropped by 23% of market price.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
      mercado_grafico21 <- function(){
        MBI <- manipulacao()
        MBI <- MBI[MBI$Flavor==c("Milk Chocolate") & MBI$`Caloric Content`=="Sugar" & MBI$AVG_PS==c("BIG","VERY SMALL"),]
        MBI1 <- pareto(MBI,MBI$Value)
        MBI1 <- MBI1[MBI1$cum_freq <= 0.2,]
        MBI1 <- aggregate(MBI1[,c("Volume","Value")], by = list(Month = MBI1$Month, Year = MBI1$Year, Brand = MBI1$Brand), FUN = sum)
        t <- MBI1%>%
          ggplot(aes(x = Month, y= Volume, fill = Brand, size = Value)) + 
          geom_point() + 
          facet_grid(Year ~ .) +
          theme(axis.title.x=element_blank(),
                axis.text.x=element_blank(),
                axis.ticks.x=element_blank(),
                axis.title.y=element_blank(),
                axis.text.y=element_blank(),
                axis.ticks.y=element_blank(),
                strip.text = element_text(size=10)) +
          guides(fill=FALSE)
        ggplotly(t)
      }
      mercado_grafico22 <- function(){
        MBI <- manipulacao()
        #MBI <- MBI[MBI$Flavor==c("Milk Chocolate","Cherry","Coffe") & MBI$`Caloric Content`=="Sugar" & MBI$AVG_PS==c("BIG","VERY SMALL"),]
        MBI <- MBI[MBI$Flavor==c("Milk Chocolate") & MBI$`Caloric Content`=="Sugar" & MBI$AVG_PS==c("BIG","VERY SMALL"),]
        MBI1 <- pareto(MBI,MBI$Value)
        #MBI2 <- pareto(MBI,MBI$Volume)
        MBI1$Brand <- ifelse(MBI1$cum_freq>0.2,"OTHERS",MBI1$Brand)
        MBI1_1 <-  aggregate(MBI1[MBI1$Brand=="OTHERS",c("Volume","Value")], by = list(Month = MBI1[MBI1$Brand=="OTHERS",]$Month, Year = MBI1[MBI1$Brand=="OTHERS",]$Year, Brand = MBI1[MBI1$Brand=="OTHERS",]$Brand), FUN = sum)%>%
          mutate(Price = Value/Volume)
        MBI1 <- aggregate(MBI1[MBI1$cum_freq <= 0.2,c("Volume","Value")], by = list(Month = MBI1[MBI1$cum_freq <= 0.2,]$Month, Year = MBI1[MBI1$cum_freq <= 0.2,]$Year, Brand = MBI1[MBI1$cum_freq <= 0.2,]$Brand), FUN = sum)%>%
          mutate(Price = Value/Volume)
        MBI1 <- rbind(MBI1,MBI1_1)
        MBI1$Price <- round(MBI1$Price,2)
        
        price_market <- aggregate(MBI[,c("Volume","Value")], by = list(Month = MBI$Month, Year = MBI$Year), FUN = sum)
        price_market$Price <- round(price_market$Value/price_market$Volume,2)
        price_market$Brand <- "Market"
        MBI1 <- rbind(MBI1,price_market)
        
        MBI1$Price_index <- round(as.numeric(MBI1$Price)/price_market[match(paste(MBI1$Month,MBI1$Year,"Market", sep = " - "),paste(price_market$Month,price_market$Year,"Market", sep = " - ")),"Price"],3)
        
        t <- MBI1%>%
          ggplot(aes(x = Month, y= Price_index, colour = Brand)) + 
          geom_line() + 
          facet_grid(Year ~ .) +
          theme(axis.title.x=element_blank(),
                axis.text.x=element_blank(),
                axis.ticks.x=element_blank(),
                axis.title.y=element_blank(),
                axis.text.y=element_blank(),
                axis.ticks.y=element_blank(),
                strip.text = element_text(size=10)) +
          guides(fill=FALSE) + 
          geom_line(linetype = "dashed",aes(x = Month, y= 1),color="black", size=1)
        ggplotly(t)
      }
      mercado_grafico23 <- function(){
        MBI <- manipulacao()
        #MBI <- MBI[MBI$Flavor==c("Milk Chocolate","Cherry","Coffe") & MBI$`Caloric Content`=="Sugar" & MBI$AVG_PS==c("BIG","VERY SMALL"),]
        MBI <- MBI[MBI$Flavor==c("Milk Chocolate") & MBI$`Caloric Content`=="Sugar" & MBI$AVG_PS==c("BIG","VERY SMALL"),]
        #MBI1 <- pareto(MBI,MBI$Value)
        MBI2 <- pareto(MBI,MBI$Volume)
        MBI2$Brand <- ifelse(MBI2$cum_freq>0.2,"OTHERS",MBI2$Brand)
        MBI2_1 <-  aggregate(MBI2[MBI2$Brand=="OTHERS",c("Volume","Value")], by = list(Month = MBI2[MBI2$Brand=="OTHERS",]$Month, Year = MBI2[MBI2$Brand=="OTHERS",]$Year, Brand = MBI2[MBI2$Brand=="OTHERS",]$Brand), FUN = sum)%>%
          mutate(Price = Value/Volume)
        MBI2 <- aggregate(MBI2[MBI2$cum_freq <= 0.2,c("Volume","Value")], by = list(Month = MBI2[MBI2$cum_freq <= 0.2,]$Month, Year = MBI2[MBI2$cum_freq <= 0.2,]$Year, Brand = MBI2[MBI2$cum_freq <= 0.2,]$Brand), FUN = sum)%>%
          mutate(Price = Value/Volume)
        MBI2 <- rbind(MBI2,MBI2_1)
        MBI2$Price <- round(MBI2$Price,2)
        
        total_mercado_volume <- aggregate(MBI[,c("Volume","Value")], by = list(Month = MBI$Month, Year = MBI$Year), FUN = sum)
        total_mercado_volume$Price <- round(total_mercado_volume$Value/total_mercado_volume$Volume,2)
        total_mercado_volume$Brand <- "Market"
        MBI2 <- rbind(MBI2,total_mercado_volume)
        
        MBI2$Share_volume <- round(as.numeric(MBI2$Volume)/total_mercado_volume[match(paste(MBI2$Month,MBI2$Year,"Market", sep = " - "),paste(total_mercado_volume$Month,total_mercado_volume$Year,"Market", sep = " - ")),"Volume"],3)
        
        t <- MBI2%>%
          ggplot(aes(x = Month, y= Share_volume, colour = Brand)) + 
          geom_line() + 
          facet_grid(Year ~ .) +
          theme(axis.title.x=element_blank(),
                axis.text.x=element_blank(),
                axis.ticks.x=element_blank(),
                axis.title.y=element_blank(),
                axis.text.y=element_blank(),
                axis.ticks.y=element_blank(),
                strip.text = element_text(size=10)) +
          guides(fill=FALSE) 
        #+ geom_line(linetype = "dashed",aes(x = Month, y= 1),color="black", size=1)
        ggplotly(t)
      }
      mercado_grafico24 <- function(){
        MBI <- manipulacao()
        #MBI <- MBI[MBI$Flavor==c("Milk Chocolate","Cherry","Coffe") & MBI$`Caloric Content`=="Sugar" & MBI$AVG_PS==c("BIG","VERY SMALL"),]
        MBI <- MBI[MBI$Flavor==c("Milk Chocolate") & MBI$`Caloric Content`=="Sugar" & MBI$AVG_PS==c("BIG","VERY SMALL"),]
        #MBI1 <- pareto(MBI,MBI$Value)
        MBI2 <- pareto(MBI,MBI$Volume)
        MBI2$Brand <- ifelse(MBI2$cum_freq>0.2,"OTHERS",MBI2$Brand)
        MBI2_1 <-  aggregate(MBI2[MBI2$Brand=="OTHERS",c("Volume","Value")], by = list(Month = MBI2[MBI2$Brand=="OTHERS",]$Month, Year = MBI2[MBI2$Brand=="OTHERS",]$Year, Brand = MBI2[MBI2$Brand=="OTHERS",]$Brand), FUN = sum)%>%
          mutate(Price = Value/Volume)
        MBI2 <- aggregate(MBI2[MBI2$cum_freq <= 0.2,c("Volume","Value")], by = list(Month = MBI2[MBI2$cum_freq <= 0.2,]$Month, Year = MBI2[MBI2$cum_freq <= 0.2,]$Year, Brand = MBI2[MBI2$cum_freq <= 0.2,]$Brand), FUN = sum)%>%
          mutate(Price = Value/Volume)
        MBI2 <- rbind(MBI2,MBI2_1)
        MBI2$Price <- round(MBI2$Price,2)
        
        total_mercado_valor <- aggregate(MBI[,c("Volume","Value")], by = list(Month = MBI$Month, Year = MBI$Year), FUN = sum)
        total_mercado_valor$Price <- round(total_mercado_valor$Value/total_mercado_valor$Volume,2)
        total_mercado_valor$Brand <- "Market"
        MBI2 <- rbind(MBI2,total_mercado_valor)
        
        MBI2$Share_value <- round(as.numeric(MBI2$Value)/total_mercado_valor[match(paste(MBI2$Month,MBI2$Year,"Market", sep = " - "),paste(total_mercado_valor$Month,total_mercado_valor$Year,"Market", sep = " - ")),"Value"],3)
        
        t <- MBI2%>%
          ggplot(aes(x = Month, y= Share_value, colour = Brand)) + 
          geom_line() + 
          facet_grid(Year ~ .) +
          theme(axis.title.x=element_blank(),
                axis.text.x=element_blank(),
                axis.ticks.x=element_blank(),
                axis.title.y=element_blank(),
                axis.text.y=element_blank(),
                axis.ticks.y=element_blank(),
                strip.text = element_text(size=10)) +
          guides(fill=FALSE) 
        #+ geom_line(linetype = "dashed",aes(x = Month, y= 1),color="black", size=1)
        ggplotly(t)
      }
      mercado_grafico21()
      mercado_grafico22()
      mercado_grafico23()
      mercado_grafico24()
```

The Lily was chosen to apply a forecast, even the last share volume had a suddenly drop this won't reflect a long term.
The forecast model that I used was ![Prophet] (https://research.fb.com/prophet-forecasting-at-scale/) developed by Facebbok. As you can see I train a dataset which have resulted a low error.

```{r pressure, echo=FALSE, message=FALSE, warning=FALSE}
    forecast1 <- function(){
      MBI <- manipulacao()
      MBI <- MBI[MBI$Flavor==c("Milk Chocolate") & MBI$`Caloric Content`=="Sugar" & MBI$AVG_PS==c("BIG","VERY SMALL") & MBI$Brand=="Lili",]
      MBI2 <- pareto(MBI,MBI$Volume)
      MBI2$Brand <- ifelse(MBI2$cum_freq>0.2,"OTHERS",MBI2$Brand)
      MBI2_1 <-  aggregate(MBI2[MBI2$Brand=="OTHERS",c("Volume","Value")], by = list(Date = MBI2[MBI2$Brand=="OTHERS",]$Date, Brand = MBI2[MBI2$Brand=="OTHERS",]$Brand), FUN = sum)%>%
        mutate(Price = Value/Volume)
      MBI2 <- aggregate(MBI2[MBI2$cum_freq <= 0.2,c("Volume","Value")], by = list(Date = MBI2[MBI2$cum_freq <= 0.2,]$Date, Brand = MBI2[MBI2$cum_freq <= 0.2,]$Brand), FUN = sum)%>%
        mutate(Price = Value/Volume)
      MBI2 <- rbind(MBI2,MBI2_1)
      MBI2$Price <- round(MBI2$Price,2)
      MBI_MERCADO <- MBI2
      
      M <- MBI_MERCADO[,c("Date","Volume")]
      ## 75% DO TAMANHO DA AMOSTRA
      tamanho_amostra <- floor(0.75 * nrow(M))
      
      train <- M[1:tamanho_amostra, ]
      test <- M[tamanho_amostra:NROW(M), ]
      colnames(train) <- c('ds', 'y')
      train <- na.omit(train)
      M1 <- prophet::prophet(train)
      return(M1)
    }
    forecast_grafico1 <- function(){
      M1 <- forecast1()
      future <- make_future_dataframe(M1, periods = 365)
      forecast <- predict(M1, future)
      x <- plot(M1, forecast)
      ggplotly(x)  
    }
    forecast_grafico1()
```

```{r pressure, echo=FALSE, message=FALSE, warning=FALSE}
forecast_erro1 <- function(){
      M1 <- forecast1()
      future <- make_future_dataframe(M1, periods = 365)
      forecast <- predict(M1, future)  
      forc <- forecast[,c("ds","yhat")]
      colnames(forc) <- c("Date","Volume")
      test <- dplyr::left_join(test,forc, by = "Date")
      
    d <-   list(
      "rmsle" = round(rmsle(test$Volume.x,test$Volume.y),2),
      "mape" = round(mape(test$Volume.x,test$Volume.y),2),
      "mae" = mae(test$Volume.x,test$Volume.y),
      "rmse" = rmse(test$Volume.x,test$Volume.y)
      )
    d <- as.data.frame(d)
    grid.table(d,rows=NULL)
    } 
    forecast_grafico1()
```
##Forward Studies

- Develop a model with external insight then predict how the market will react.
- Rewrite on Python for be more flexible to access the tensorflow library then use Deep Learning Models.